<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æ”¯ä»˜å®æ”¯ä»˜æµ‹è¯•</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    .container {
      background: white;
      border-radius: 20px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      padding: 40px;
      max-width: 600px;
      width: 100%;
    }

    h1 {
      color: #333;
      margin-bottom: 10px;
      font-size: 28px;
    }

    .subtitle {
      color: #666;
      margin-bottom: 30px;
      font-size: 14px;
    }

    .test-section {
      margin-bottom: 30px;
      padding: 20px;
      background: #f8f9fa;
      border-radius: 10px;
      border-left: 4px solid #667eea;
    }

    .test-section h2 {
      color: #333;
      font-size: 18px;
      margin-bottom: 15px;
    }

    .form-group {
      margin-bottom: 15px;
    }

    label {
      display: block;
      color: #555;
      margin-bottom: 5px;
      font-size: 14px;
      font-weight: 500;
    }

    input, select {
      width: 100%;
      padding: 12px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 14px;
      transition: border-color 0.3s;
    }

    input:focus, select:focus {
      outline: none;
      border-color: #667eea;
    }

    button {
      width: 100%;
      padding: 14px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.2s, box-shadow 0.2s;
    }

    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 20px rgba(102, 126, 234, 0.4);
    }

    button:active {
      transform: translateY(0);
    }

    button:disabled {
      background: #ccc;
      cursor: not-allowed;
      transform: none;
    }

    .result {
      margin-top: 20px;
      padding: 15px;
      border-radius: 8px;
      font-size: 14px;
      display: none;
    }

    .result.success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
      display: block;
    }

    .result.error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
      display: block;
    }

    .result.info {
      background: #d1ecf1;
      color: #0c5460;
      border: 1px solid #bee5eb;
      display: block;
    }

    .loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid rgba(255, 255, 255, 0.3);
      border-radius: 50%;
      border-top-color: white;
      animation: spin 1s ease-in-out infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .info-box {
      background: #fff3cd;
      border: 1px solid #ffeaa7;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 20px;
    }

    .info-box h3 {
      color: #856404;
      font-size: 16px;
      margin-bottom: 10px;
    }

    .info-box p {
      color: #856404;
      font-size: 13px;
      line-height: 1.6;
      margin-bottom: 5px;
    }

    .info-box code {
      background: #fff;
      padding: 2px 6px;
      border-radius: 4px;
      font-family: 'Courier New', monospace;
      font-size: 12px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ§ª æ”¯ä»˜å®æ”¯ä»˜æµ‹è¯•</h1>
    <p class="subtitle">æµ‹è¯•æ”¯ä»˜å®æ²™ç®±ç¯å¢ƒé›†æˆ</p>

    <div class="info-box">
      <h3>ğŸ“ æµ‹è¯•è¯´æ˜</h3>
      <p>1. ç¡®ä¿åç«¯æœåŠ¡è¿è¡Œåœ¨ <code>http://localhost:3001</code></p>
      <p>2. ä½¿ç”¨æ”¯ä»˜å®æ²™ç®±è´¦å·è¿›è¡Œæµ‹è¯•</p>
      <p>3. æ²™ç®±ç¯å¢ƒæ”¯ä»˜å¯†ç é€šå¸¸æ˜¯ <code>111111</code></p>
      <p>4. æµ‹è¯•é‡‘é¢å»ºè®®ä½¿ç”¨ <code>0.01</code> å…ƒ</p>
    </div>

    <!-- æµ‹è¯• 1: åˆ›å»ºæ”¯ä»˜è®¢å• -->
    <div class="test-section">
      <h2>æµ‹è¯• 1: åˆ›å»ºæ”¯ä»˜è®¢å•</h2>
      
      <div class="form-group">
        <label>è®¢å•é‡‘é¢ï¼ˆå…ƒï¼‰</label>
        <input type="number" id="amount" value="0.01" step="0.01" min="0.01">
      </div>

      <div class="form-group">
        <label>å•†å“åç§°</label>
        <input type="text" id="subject" value="å°çº¢ä¹¦æ”»ç•¥ç”Ÿæˆå™¨ - æœˆåº¦ä¼šå‘˜">
      </div>

      <div class="form-group">
        <label>æ”¯ä»˜æ–¹å¼</label>
        <select id="paymentType">
          <option value="page">ç”µè„‘ç½‘ç«™æ”¯ä»˜</option>
          <option value="wap">æ‰‹æœºç½‘ç«™æ”¯ä»˜</option>
        </select>
      </div>

      <button onclick="createPayment()">åˆ›å»ºæ”¯ä»˜è®¢å•</button>
      
      <div id="paymentResult" class="result"></div>
    </div>

    <!-- æµ‹è¯• 2: æŸ¥è¯¢è®¢å• -->
    <div class="test-section">
      <h2>æµ‹è¯• 2: æŸ¥è¯¢è®¢å•çŠ¶æ€</h2>
      
      <div class="form-group">
        <label>è®¢å•å·</label>
        <input type="text" id="queryOrderNo" placeholder="è¾“å…¥è®¢å•å·ï¼Œä¾‹å¦‚ï¼šXHS1732012345678901234">
      </div>

      <button onclick="queryOrder()">æŸ¥è¯¢è®¢å•</button>
      
      <div id="queryResult" class="result"></div>
    </div>

    <!-- æµ‹è¯• 3: å…³é—­è®¢å• -->
    <div class="test-section">
      <h2>æµ‹è¯• 3: å…³é—­è®¢å•</h2>
      
      <div class="form-group">
        <label>è®¢å•å·</label>
        <input type="text" id="closeOrderNo" placeholder="è¾“å…¥è¦å…³é—­çš„è®¢å•å·">
      </div>

      <button onclick="closeOrder()">å…³é—­è®¢å•</button>
      
      <div id="closeResult" class="result"></div>
    </div>
  </div>

  <script>
    const API_BASE = 'http://localhost:3001/api/payment';

    // åˆ›å»ºæ”¯ä»˜è®¢å•
    async function createPayment() {
      const amount = document.getElementById('amount').value;
      const subject = document.getElementById('subject').value;
      const paymentType = document.getElementById('paymentType').value;
      const resultDiv = document.getElementById('paymentResult');
      
      resultDiv.className = 'result info';
      resultDiv.innerHTML = '<div class="loading"></div> æ­£åœ¨åˆ›å»ºè®¢å•...';

      try {
        const response = await fetch(`${API_BASE}/create-order`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            amount: parseFloat(amount),
            planType: 'monthly',
            userId: 'test-user-' + Date.now(),
            paymentType: paymentType
          })
        });

        const data = await response.json();

        if (data.success) {
          resultDiv.className = 'result success';
          resultDiv.innerHTML = `
            <strong>âœ… è®¢å•åˆ›å»ºæˆåŠŸï¼</strong><br>
            è®¢å•å·: ${data.orderNo}<br>
            <br>
            <strong>æ”¯ä»˜é“¾æ¥å·²ç”Ÿæˆï¼Œå³å°†è·³è½¬...</strong><br>
            <small>å¦‚æœæ²¡æœ‰è‡ªåŠ¨è·³è½¬ï¼Œè¯·æ‰‹åŠ¨è®¿é—®æ”¯ä»˜é“¾æ¥</small>
          `;

          // ä¿å­˜è®¢å•å·åˆ°æŸ¥è¯¢æ¡†
          document.getElementById('queryOrderNo').value = data.orderNo;
          document.getElementById('closeOrderNo').value = data.orderNo;

          // 3ç§’åè·³è½¬åˆ°æ”¯ä»˜é¡µé¢
          setTimeout(() => {
            // åˆ›å»ºä¸€ä¸ªè¡¨å•å¹¶æäº¤ï¼ˆæ”¯ä»˜å®è¿”å›çš„æ˜¯ HTML è¡¨å•ï¼‰
            const div = document.createElement('div');
            div.innerHTML = data.paymentUrl;
            document.body.appendChild(div);
            const form = div.querySelector('form');
            if (form) {
              form.submit();
            } else {
              // å¦‚æœæ˜¯ URLï¼Œç›´æ¥è·³è½¬
              window.location.href = data.paymentUrl;
            }
          }, 3000);
        } else {
          throw new Error(data.message || 'åˆ›å»ºè®¢å•å¤±è´¥');
        }
      } catch (error) {
        resultDiv.className = 'result error';
        resultDiv.innerHTML = `<strong>âŒ é”™è¯¯ï¼š</strong>${error.message}`;
      }
    }

    // æŸ¥è¯¢è®¢å•
    async function queryOrder() {
      const orderNo = document.getElementById('queryOrderNo').value;
      const resultDiv = document.getElementById('queryResult');

      if (!orderNo) {
        resultDiv.className = 'result error';
        resultDiv.innerHTML = 'è¯·è¾“å…¥è®¢å•å·';
        return;
      }

      resultDiv.className = 'result info';
      resultDiv.innerHTML = '<div class="loading"></div> æ­£åœ¨æŸ¥è¯¢...';

      try {
        const response = await fetch(`${API_BASE}/query-order?orderNo=${orderNo}`);
        const data = await response.json();

        if (data.success) {
          const order = data.order;
          const statusMap = {
            'pending': 'â³ å¾…æ”¯ä»˜',
            'paid': 'âœ… å·²æ”¯ä»˜',
            'failed': 'âŒ æ”¯ä»˜å¤±è´¥',
            'cancelled': 'ğŸš« å·²å–æ¶ˆ'
          };

          resultDiv.className = 'result success';
          resultDiv.innerHTML = `
            <strong>è®¢å•ä¿¡æ¯ï¼š</strong><br>
            è®¢å•å·: ${order.order_no}<br>
            çŠ¶æ€: ${statusMap[order.status] || order.status}<br>
            é‡‘é¢: Â¥${order.amount}<br>
            å¥—é¤: ${order.plan_type}<br>
            åˆ›å»ºæ—¶é—´: ${new Date(order.created_at).toLocaleString()}<br>
            ${order.paid_at ? `æ”¯ä»˜æ—¶é—´: ${new Date(order.paid_at).toLocaleString()}` : ''}
          `;
        } else {
          throw new Error(data.message || 'æŸ¥è¯¢å¤±è´¥');
        }
      } catch (error) {
        resultDiv.className = 'result error';
        resultDiv.innerHTML = `<strong>âŒ é”™è¯¯ï¼š</strong>${error.message}`;
      }
    }

    // å…³é—­è®¢å•
    async function closeOrder() {
      const orderNo = document.getElementById('closeOrderNo').value;
      const resultDiv = document.getElementById('closeResult');

      if (!orderNo) {
        resultDiv.className = 'result error';
        resultDiv.innerHTML = 'è¯·è¾“å…¥è®¢å•å·';
        return;
      }

      if (!confirm('ç¡®å®šè¦å…³é—­è¿™ä¸ªè®¢å•å—ï¼Ÿ')) {
        return;
      }

      resultDiv.className = 'result info';
      resultDiv.innerHTML = '<div class="loading"></div> æ­£åœ¨å…³é—­è®¢å•...';

      try {
        const response = await fetch(`${API_BASE}/close-order`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ orderNo })
        });

        const data = await response.json();

        if (data.success) {
          resultDiv.className = 'result success';
          resultDiv.innerHTML = `<strong>âœ… è®¢å•å·²å…³é—­</strong>`;
        } else {
          throw new Error(data.message || 'å…³é—­è®¢å•å¤±è´¥');
        }
      } catch (error) {
        resultDiv.className = 'result error';
        resultDiv.innerHTML = `<strong>âŒ é”™è¯¯ï¼š</strong>${error.message}`;
      }
    }
  </script>
</body>
</html>
