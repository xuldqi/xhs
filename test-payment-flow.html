<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æ”¯ä»˜å®æ”¯ä»˜æµç¨‹æµ‹è¯•</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 800px;
      margin: 0 auto;
    }

    .card {
      background: white;
      border-radius: 12px;
      padding: 30px;
      margin-bottom: 20px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
    }

    h1 {
      color: #333;
      margin-bottom: 10px;
      font-size: 28px;
    }

    h2 {
      color: #555;
      margin-bottom: 20px;
      font-size: 20px;
      border-bottom: 2px solid #667eea;
      padding-bottom: 10px;
    }

    .status {
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 20px;
      font-weight: 500;
    }

    .status.success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }

    .status.error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }

    .status.warning {
      background: #fff3cd;
      color: #856404;
      border: 1px solid #ffeaa7;
    }

    .status.info {
      background: #d1ecf1;
      color: #0c5460;
      border: 1px solid #bee5eb;
    }

    .form-group {
      margin-bottom: 20px;
    }

    label {
      display: block;
      margin-bottom: 8px;
      color: #555;
      font-weight: 500;
    }

    input, select {
      width: 100%;
      padding: 12px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 16px;
      transition: border-color 0.3s;
    }

    input:focus, select:focus {
      outline: none;
      border-color: #667eea;
    }

    button {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      padding: 14px 28px;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.2s, box-shadow 0.2s;
      margin-right: 10px;
      margin-bottom: 10px;
    }

    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
    }

    button:active {
      transform: translateY(0);
    }

    button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }

    .btn-secondary {
      background: linear-gradient(135deg, #6c757d 0%, #495057 100%);
    }

    .btn-success {
      background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
    }

    .result {
      background: #f8f9fa;
      border: 1px solid #dee2e6;
      border-radius: 8px;
      padding: 15px;
      margin-top: 15px;
      font-family: 'Courier New', monospace;
      font-size: 14px;
      max-height: 400px;
      overflow-y: auto;
      white-space: pre-wrap;
      word-wrap: break-word;
    }

    .step {
      background: #f8f9fa;
      padding: 15px;
      border-left: 4px solid #667eea;
      margin-bottom: 15px;
      border-radius: 4px;
    }

    .step-title {
      font-weight: 600;
      color: #667eea;
      margin-bottom: 8px;
    }

    .step-desc {
      color: #666;
      font-size: 14px;
    }

    .loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid rgba(255, 255, 255, 0.3);
      border-radius: 50%;
      border-top-color: white;
      animation: spin 1s ease-in-out infinite;
      margin-left: 10px;
      vertical-align: middle;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .config-item {
      display: flex;
      justify-content: space-between;
      padding: 10px;
      border-bottom: 1px solid #e0e0e0;
    }

    .config-item:last-child {
      border-bottom: none;
    }

    .config-label {
      font-weight: 500;
      color: #555;
    }

    .config-value {
      color: #28a745;
      font-weight: 600;
    }

    .config-value.error {
      color: #dc3545;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="card">
      <h1>ğŸ§ª æ”¯ä»˜å®æ”¯ä»˜æµç¨‹æµ‹è¯•</h1>
      <p style="color: #666; margin-top: 10px;">å®Œæ•´æµ‹è¯•æ”¯ä»˜å®æ”¯ä»˜å’Œä¼šå‘˜å¼€é€šæµç¨‹</p>
    </div>

    <!-- é…ç½®æ£€æŸ¥ -->
    <div class="card">
      <h2>1ï¸âƒ£ é…ç½®æ£€æŸ¥</h2>
      <div id="configStatus" class="status info">
        ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®æ£€æŸ¥é…ç½®...
      </div>
      <button onclick="checkConfig()">æ£€æŸ¥é…ç½®</button>
      <div id="configResult" class="result" style="display: none;"></div>
    </div>

    <!-- åˆ›å»ºè®¢å• -->
    <div class="card">
      <h2>2ï¸âƒ£ åˆ›å»ºæ”¯ä»˜è®¢å•</h2>
      
      <div class="form-group">
        <label>ç”¨æˆ· IDï¼ˆæµ‹è¯•ç”¨ï¼‰</label>
        <input type="text" id="userId" value="test-user-123" placeholder="è¾“å…¥æµ‹è¯•ç”¨æˆ· ID">
      </div>

      <div class="form-group">
        <label>å¥—é¤ç±»å‹</label>
        <select id="planType">
          <option value="basic">åŸºç¡€ä¼šå‘˜ - Â¥29.9/æœˆ</option>
          <option value="pro" selected>ä¸“ä¸šä¼šå‘˜ - Â¥99/æœˆ</option>
          <option value="lifetime">ç»ˆèº«ä¼šå‘˜ - Â¥299</option>
        </select>
      </div>

      <div class="form-group">
        <label>æµ‹è¯•é‡‘é¢ï¼ˆå…ƒï¼‰</label>
        <input type="number" id="testAmount" value="0.01" step="0.01" min="0.01" placeholder="å»ºè®®ä½¿ç”¨ 0.01 å…ƒæµ‹è¯•">
        <small style="color: #666; display: block; margin-top: 5px;">
          ğŸ’¡ æ²™ç®±ç¯å¢ƒå»ºè®®ä½¿ç”¨ 0.01 å…ƒè¿›è¡Œæµ‹è¯•
        </small>
      </div>

      <button onclick="createOrder()">åˆ›å»ºè®¢å•å¹¶è·³è½¬æ”¯ä»˜</button>
      <button onclick="createOrderTest()" class="btn-secondary">ä»…åˆ›å»ºè®¢å•ï¼ˆä¸è·³è½¬ï¼‰</button>
      
      <div id="orderResult" class="result" style="display: none;"></div>
    </div>

    <!-- æŸ¥è¯¢è®¢å• -->
    <div class="card">
      <h2>3ï¸âƒ£ æŸ¥è¯¢è®¢å•çŠ¶æ€</h2>
      
      <div class="form-group">
        <label>è®¢å•å·</label>
        <input type="text" id="orderNo" placeholder="è¾“å…¥è®¢å•å·ï¼Œå¦‚ï¼šXHS1732012345678901234">
      </div>

      <button onclick="queryOrder()" class="btn-success">æŸ¥è¯¢è®¢å•</button>
      
      <div id="queryResult" class="result" style="display: none;"></div>
    </div>

    <!-- æµ‹è¯•æŒ‡å— -->
    <div class="card">
      <h2>ğŸ“– æµ‹è¯•æ­¥éª¤æŒ‡å—</h2>
      
      <div class="step">
        <div class="step-title">æ­¥éª¤ 1: æ£€æŸ¥é…ç½®</div>
        <div class="step-desc">
          ç¡®ä¿ Supabase å’Œæ”¯ä»˜å®é…ç½®æ­£ç¡®ã€‚å¦‚æœé…ç½®æœ‰é—®é¢˜ï¼Œè¯·å…ˆä¿®å¤é…ç½®ã€‚
        </div>
      </div>

      <div class="step">
        <div class="step-title">æ­¥éª¤ 2: åˆ›å»ºè®¢å•</div>
        <div class="step-desc">
          è¾“å…¥æµ‹è¯•ç”¨æˆ· ID å’Œå¥—é¤ç±»å‹ï¼Œç‚¹å‡»"åˆ›å»ºè®¢å•å¹¶è·³è½¬æ”¯ä»˜"ã€‚ç³»ç»Ÿä¼šè‡ªåŠ¨è·³è½¬åˆ°æ”¯ä»˜å®æ²™ç®±æ”¶é“¶å°ã€‚
        </div>
      </div>

      <div class="step">
        <div class="step-title">æ­¥éª¤ 3: å®Œæˆæ”¯ä»˜</div>
        <div class="step-desc">
          åœ¨æ”¯ä»˜å®æ²™ç®±é¡µé¢ä½¿ç”¨æµ‹è¯•è´¦å·ç™»å½•å¹¶å®Œæˆæ”¯ä»˜ã€‚æ²™ç®±è´¦å·å¯åœ¨æ”¯ä»˜å®å¼€æ”¾å¹³å°è·å–ã€‚
        </div>
      </div>

      <div class="step">
        <div class="step-title">æ­¥éª¤ 4: éªŒè¯ç»“æœ</div>
        <div class="step-desc">
          æ”¯ä»˜å®Œæˆåï¼Œä½¿ç”¨è®¢å•å·æŸ¥è¯¢è®¢å•çŠ¶æ€ï¼Œç¡®è®¤è®¢å•å·²æ”¯ä»˜ä¸”ä¼šå‘˜æƒç›Šå·²å¼€é€šã€‚
        </div>
      </div>
    </div>

    <!-- å¸¸è§é—®é¢˜ -->
    <div class="card">
      <h2>â“ å¸¸è§é—®é¢˜</h2>
      
      <div class="step">
        <div class="step-title">Q: Supabase æœªé…ç½®æ€ä¹ˆåŠï¼Ÿ</div>
        <div class="step-desc">
          è®¿é—® https://supabase.com/ åˆ›å»ºé¡¹ç›®ï¼Œç„¶ååœ¨ backend/.env ä¸­é…ç½® SUPABASE_URL å’Œ SUPABASE_SERVICE_KEYã€‚
        </div>
      </div>

      <div class="step">
        <div class="step-title">Q: å¦‚ä½•è·å–æ”¯ä»˜å®æ²™ç®±æµ‹è¯•è´¦å·ï¼Ÿ</div>
        <div class="step-desc">
          è®¿é—® https://open.alipay.com/develop/sandbox/app ç™»å½•åå³å¯æŸ¥çœ‹æ²™ç®±ä¹°å®¶è´¦å·å’Œå¯†ç ã€‚
        </div>
      </div>

      <div class="step">
        <div class="step-title">Q: æ”¯ä»˜åè®¢å•çŠ¶æ€æœªæ›´æ–°ï¼Ÿ</div>
        <div class="step-desc">
          æ£€æŸ¥åç«¯æ—¥å¿—ï¼Œç¡®è®¤æ˜¯å¦æ”¶åˆ°æ”¯ä»˜å®å¼‚æ­¥é€šçŸ¥ã€‚æœ¬åœ°å¼€å‘å¯èƒ½éœ€è¦ä½¿ç”¨å†…ç½‘ç©¿é€å·¥å…·ï¼ˆå¦‚ ngrokï¼‰ã€‚
        </div>
      </div>
    </div>
  </div>

  <script>
    const API_BASE = 'http://localhost:3001';

    // æ£€æŸ¥é…ç½®
    async function checkConfig() {
      const statusEl = document.getElementById('configStatus');
      const resultEl = document.getElementById('configResult');
      
      statusEl.className = 'status info';
      statusEl.innerHTML = 'æ­£åœ¨æ£€æŸ¥é…ç½®... <span class="loading"></span>';
      resultEl.style.display = 'none';

      try {
        // ä½¿ç”¨æ–°çš„å¥åº·æ£€æŸ¥ API
        const response = await fetch(`${API_BASE}/api/health/detailed`);
        const data = await response.json();
        
        resultEl.textContent = JSON.stringify(data, null, 2);
        resultEl.style.display = 'block';

        if (data.status === 'healthy') {
          statusEl.className = 'status success';
          statusEl.innerHTML = 'âœ… é…ç½®æ£€æŸ¥é€šè¿‡ï¼æ‰€æœ‰æœåŠ¡å·²å°±ç»ªã€‚';
        } else {
          statusEl.className = 'status warning';
          let issues = [];
          
          // æ£€æŸ¥å„æœåŠ¡çŠ¶æ€
          if (data.services?.supabase?.status !== 'ok') {
            issues.push('Supabase: ' + (data.services.supabase?.message || 'æœªè¿æ¥'));
          }
          if (data.services?.alipay?.status !== 'ok') {
            issues.push('æ”¯ä»˜å®: ' + (data.services.alipay?.message || 'æœªåˆå§‹åŒ–'));
          }
          if (data.services?.deepseek?.status !== 'ok') {
            issues.push('DeepSeek: ' + (data.services.deepseek?.message || 'é…ç½®é”™è¯¯'));
          }
          if (data.services?.gemini?.status !== 'ok') {
            issues.push('Gemini: ' + (data.services.gemini?.message || 'é…ç½®é”™è¯¯'));
          }
          
          statusEl.innerHTML = `âš ï¸ é…ç½®æœ‰é—®é¢˜ï¼š<br>${issues.join('<br>')}`;
          
          // æ˜¾ç¤ºä¿®å¤å»ºè®®
          if (data.recommendations && data.recommendations.length > 0) {
            const suggestions = data.recommendations
              .filter(r => r.severity === 'critical')
              .slice(0, 3)
              .map(r => `â€¢ ${r.service}: ${r.solution}`)
              .join('<br>');
            
            if (suggestions) {
              statusEl.innerHTML += `<br><br><strong>ä¿®å¤å»ºè®®ï¼š</strong><br>${suggestions}`;
            }
          }
        }
      } catch (error) {
        statusEl.className = 'status error';
        statusEl.innerHTML = `âŒ æ£€æŸ¥å¤±è´¥ï¼š${error.message}`;
        resultEl.textContent = error.stack;
        resultEl.style.display = 'block';
      }
    }

    // åˆ›å»ºè®¢å•å¹¶è·³è½¬
    async function createOrder() {
      const userId = document.getElementById('userId').value;
      const planType = document.getElementById('planType').value;
      const testAmount = document.getElementById('testAmount').value;
      const resultEl = document.getElementById('orderResult');

      if (!userId) {
        alert('è¯·è¾“å…¥ç”¨æˆ· ID');
        return;
      }

      resultEl.textContent = 'æ­£åœ¨åˆ›å»ºè®¢å•...';
      resultEl.style.display = 'block';

      try {
        const response = await fetch(`${API_BASE}/api/payment/create-order`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            userId,
            planType,
            testAmount: parseFloat(testAmount)
          })
        });

        const data = await response.json();
        
        if (data.success) {
          resultEl.textContent = JSON.stringify(data, null, 2);
          
          // ä¿å­˜è®¢å•å·åˆ°æŸ¥è¯¢æ¡†
          document.getElementById('orderNo').value = data.data.orderNo;
          
          // è‡ªåŠ¨è·³è½¬åˆ°æ”¯ä»˜é¡µé¢
          setTimeout(() => {
            const div = document.createElement('div');
            div.innerHTML = data.data.paymentForm;
            document.body.appendChild(div);
            div.querySelector('form').submit();
          }, 1000);
          
          alert(`è®¢å•åˆ›å»ºæˆåŠŸï¼\nè®¢å•å·ï¼š${data.data.orderNo}\n\n1ç§’åå°†è·³è½¬åˆ°æ”¯ä»˜å®æ”¯ä»˜é¡µé¢...`);
        } else {
          resultEl.textContent = `é”™è¯¯ï¼š${data.error}\n\n` + JSON.stringify(data, null, 2);
        }
      } catch (error) {
        resultEl.textContent = `è¯·æ±‚å¤±è´¥ï¼š${error.message}\n\n${error.stack}`;
      }
    }

    // ä»…åˆ›å»ºè®¢å•ï¼ˆä¸è·³è½¬ï¼‰
    async function createOrderTest() {
      const userId = document.getElementById('userId').value;
      const planType = document.getElementById('planType').value;
      const testAmount = document.getElementById('testAmount').value;
      const resultEl = document.getElementById('orderResult');

      if (!userId) {
        alert('è¯·è¾“å…¥ç”¨æˆ· ID');
        return;
      }

      resultEl.textContent = 'æ­£åœ¨åˆ›å»ºè®¢å•...';
      resultEl.style.display = 'block';

      try {
        const response = await fetch(`${API_BASE}/api/payment/create-order`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            userId,
            planType,
            testAmount: parseFloat(testAmount)
          })
        });

        const data = await response.json();
        
        if (data.success) {
          // ä¿å­˜è®¢å•å·åˆ°æŸ¥è¯¢æ¡†
          document.getElementById('orderNo').value = data.data.orderNo;
          
          resultEl.textContent = `âœ… è®¢å•åˆ›å»ºæˆåŠŸï¼\n\nè®¢å•å·ï¼š${data.data.orderNo}\né‡‘é¢ï¼šÂ¥${data.data.amount}\n\nå®Œæ•´å“åº”ï¼š\n${JSON.stringify(data, null, 2)}`;
        } else {
          resultEl.textContent = `âŒ åˆ›å»ºå¤±è´¥ï¼š${data.error}\n\n${JSON.stringify(data, null, 2)}`;
        }
      } catch (error) {
        resultEl.textContent = `âŒ è¯·æ±‚å¤±è´¥ï¼š${error.message}\n\n${error.stack}`;
      }
    }

    // æŸ¥è¯¢è®¢å•
    async function queryOrder() {
      const orderNo = document.getElementById('orderNo').value;
      const resultEl = document.getElementById('queryResult');

      if (!orderNo) {
        alert('è¯·è¾“å…¥è®¢å•å·');
        return;
      }

      resultEl.textContent = 'æ­£åœ¨æŸ¥è¯¢è®¢å•...';
      resultEl.style.display = 'block';

      try {
        const response = await fetch(`${API_BASE}/api/payment/query-order?orderNo=${orderNo}`);
        const data = await response.json();
        
        if (data.success) {
          const order = data.order;
          let statusText = '';
          
          switch(order.status) {
            case 'paid':
              statusText = 'âœ… å·²æ”¯ä»˜';
              break;
            case 'pending':
              statusText = 'â³ å¾…æ”¯ä»˜';
              break;
            case 'failed':
              statusText = 'âŒ æ”¯ä»˜å¤±è´¥';
              break;
            case 'cancelled':
              statusText = 'ğŸš« å·²å–æ¶ˆ';
              break;
            default:
              statusText = order.status;
          }
          
          resultEl.textContent = `è®¢å•çŠ¶æ€ï¼š${statusText}\n\n` + JSON.stringify(data, null, 2);
        } else {
          resultEl.textContent = `æŸ¥è¯¢å¤±è´¥ï¼š${data.error}\n\n` + JSON.stringify(data, null, 2);
        }
      } catch (error) {
        resultEl.textContent = `è¯·æ±‚å¤±è´¥ï¼š${error.message}\n\n${error.stack}`;
      }
    }

    // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æ£€æŸ¥é…ç½®
    window.addEventListener('load', () => {
      checkConfig();
    });
  </script>
</body>
</html>
