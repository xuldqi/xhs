<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æµ‹è¯•ç™»å½•çŠ¶æ€æŒä¹…åŒ–</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 800px;
      margin: 50px auto;
      padding: 20px;
    }
    .section {
      margin: 20px 0;
      padding: 20px;
      border: 1px solid #ddd;
      border-radius: 8px;
    }
    button {
      padding: 10px 20px;
      margin: 5px;
      cursor: pointer;
    }
    .success { color: green; }
    .error { color: red; }
    .info { color: blue; }
    pre {
      background: #f5f5f5;
      padding: 10px;
      border-radius: 4px;
      overflow-x: auto;
    }
  </style>
</head>
<body>
  <h1>ğŸ” ç™»å½•çŠ¶æ€æŒä¹…åŒ–æµ‹è¯•</h1>

  <div class="section">
    <h2>1. æ³¨å†Œ/ç™»å½•</h2>
    <input type="email" id="email" placeholder="é‚®ç®±" value="test@example.com">
    <input type="password" id="password" placeholder="å¯†ç " value="123456">
    <br><br>
    <button onclick="register()">æ³¨å†Œ</button>
    <button onclick="login()">ç™»å½•</button>
    <button onclick="logout()">é€€å‡º</button>
    <div id="authResult"></div>
  </div>

  <div class="section">
    <h2>2. å½“å‰çŠ¶æ€</h2>
    <button onclick="checkSession()">æ£€æŸ¥ Session</button>
    <button onclick="checkLocalStorage()">æ£€æŸ¥ LocalStorage</button>
    <button onclick="refreshPage()">åˆ·æ–°é¡µé¢</button>
    <div id="statusResult"></div>
  </div>

  <div class="section">
    <h2>3. è°ƒè¯•ä¿¡æ¯</h2>
    <div id="debugInfo"></div>
  </div>

  <script type="module">
    import { createClient } from 'https://esm.sh/@supabase/supabase-js@2'

    // ä»ç¯å¢ƒå˜é‡è¯»å–ï¼ˆéœ€è¦æ›¿æ¢ä¸ºå®é™…å€¼ï¼‰
    const SUPABASE_URL = 'YOUR_SUPABASE_URL'
    const SUPABASE_ANON_KEY = 'YOUR_SUPABASE_ANON_KEY'

    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
      auth: {
        autoRefreshToken: true,
        persistSession: true,
        detectSessionInUrl: true,
        storageKey: 'xiaohongshu-auth',
      },
    })

    // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥çŠ¶æ€
    window.addEventListener('load', async () => {
      await checkSession()
      await checkLocalStorage()
    })

    // æ³¨å†Œ
    window.register = async function() {
      const email = document.getElementById('email').value
      const password = document.getElementById('password').value
      const result = document.getElementById('authResult')

      try {
        const { data, error } = await supabase.auth.signUp({
          email,
          password,
        })

        if (error) throw error

        result.innerHTML = `<p class="success">âœ… æ³¨å†ŒæˆåŠŸï¼</p><pre>${JSON.stringify(data, null, 2)}</pre>`
        await checkSession()
      } catch (error) {
        result.innerHTML = `<p class="error">âŒ æ³¨å†Œå¤±è´¥: ${error.message}</p>`
      }
    }

    // ç™»å½•
    window.login = async function() {
      const email = document.getElementById('email').value
      const password = document.getElementById('password').value
      const result = document.getElementById('authResult')

      try {
        const { data, error } = await supabase.auth.signInWithPassword({
          email,
          password,
        })

        if (error) throw error

        result.innerHTML = `<p class="success">âœ… ç™»å½•æˆåŠŸï¼</p><pre>${JSON.stringify(data, null, 2)}</pre>`
        await checkSession()
        await checkLocalStorage()
      } catch (error) {
        result.innerHTML = `<p class="error">âŒ ç™»å½•å¤±è´¥: ${error.message}</p>`
      }
    }

    // é€€å‡º
    window.logout = async function() {
      const result = document.getElementById('authResult')

      try {
        const { error } = await supabase.auth.signOut()
        if (error) throw error

        result.innerHTML = `<p class="success">âœ… é€€å‡ºæˆåŠŸï¼</p>`
        await checkSession()
        await checkLocalStorage()
      } catch (error) {
        result.innerHTML = `<p class="error">âŒ é€€å‡ºå¤±è´¥: ${error.message}</p>`
      }
    }

    // æ£€æŸ¥ Session
    window.checkSession = async function() {
      const result = document.getElementById('statusResult')

      try {
        const { data: { session }, error } = await supabase.auth.getSession()

        if (error) throw error

        if (session) {
          result.innerHTML = `<p class="success">âœ… å·²ç™»å½•</p><pre>${JSON.stringify({
            user: session.user.email,
            expires_at: new Date(session.expires_at * 1000).toLocaleString(),
          }, null, 2)}</pre>`
        } else {
          result.innerHTML = `<p class="info">â„¹ï¸ æœªç™»å½•</p>`
        }
      } catch (error) {
        result.innerHTML = `<p class="error">âŒ æ£€æŸ¥å¤±è´¥: ${error.message}</p>`
      }
    }

    // æ£€æŸ¥ LocalStorage
    window.checkLocalStorage = function() {
      const debugInfo = document.getElementById('debugInfo')
      const storageKey = 'xiaohongshu-auth'
      
      const keys = []
      for (let i = 0; i < localStorage.length; i++) {
        const key = localStorage.key(i)
        if (key.includes('auth') || key.includes('supabase')) {
          keys.push({
            key,
            value: localStorage.getItem(key)
          })
        }
      }

      debugInfo.innerHTML = `<h3>LocalStorage å†…å®¹:</h3><pre>${JSON.stringify(keys, null, 2)}</pre>`
    }

    // åˆ·æ–°é¡µé¢
    window.refreshPage = function() {
      location.reload()
    }

    // ç›‘å¬è®¤è¯çŠ¶æ€å˜åŒ–
    supabase.auth.onAuthStateChange((event, session) => {
      console.log('ğŸ”” Auth State Changed:', event, session)
      const debugInfo = document.getElementById('debugInfo')
      debugInfo.innerHTML += `<p class="info">ğŸ”” äº‹ä»¶: ${event} at ${new Date().toLocaleTimeString()}</p>`
    })
  </script>
</body>
</html>
