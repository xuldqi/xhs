# 支付宝沙箱环境测试指南

## 📋 测试前准备

### 1. 确认环境配置

检查 `backend/.env` 文件中的支付宝配置：

```bash
ALIPAY_APP_ID=2021006107647819
ALIPAY_PRIVATE_KEY=你的应用私钥
ALIPAY_PUBLIC_KEY=支付宝公钥
ALIPAY_GATEWAY=https://openapi.alipaydev.com/gateway.do  # 沙箱环境
FRONTEND_URL=http://localhost:5174
BACKEND_URL=http://localhost:3001
```

### 2. 启动服务

```bash
# 启动后端服务
cd backend
npm run dev

# 启动前端服务（新终端）
cd ..
npm run dev
```

### 3. 获取沙箱测试账号

访问支付宝开放平台沙箱环境：
- 地址：https://open.alipay.com/develop/sandbox/app
- 登录后可以看到：
  - 买家账号（用于支付测试）
  - 卖家账号（商户账号）
  - 沙箱钱包 APP 下载链接

## 🧪 测试流程

### 测试 1: 完整支付流程测试

#### 步骤 1: 访问前端应用
1. 打开浏览器访问：http://localhost:5174
2. 如果未登录，先注册/登录账号

#### 步骤 2: 进入会员购买页面
1. 点击导航栏的"会员中心"或"升级会员"
2. 选择一个会员套餐（建议选择最便宜的测试）

#### 步骤 3: 创建支付订单
1. 点击"立即购买"按钮
2. 系统会自动跳转到支付宝收银台页面
3. 观察浏览器地址栏，应该是 `https://openapi.alipaydev.com/gateway.do?...`

#### 步骤 4: 完成支付
1. 在支付宝沙箱收银台页面，使用沙箱买家账号登录
2. 确认支付金额和订单信息
3. 点击"确认付款"
4. 输入支付密码（沙箱环境默认密码通常是 111111）

#### 步骤 5: 验证支付结果
1. 支付成功后，会自动跳转回前端应用
2. 应该看到"支付成功"的提示页面
3. 检查会员状态是否已更新

#### 步骤 6: 验证后端日志
查看后端控制台日志，应该看到：
```
✅ Created Alipay page payment: XHS...
✅ Alipay notify signature valid
✅ Payment successful, updating order status
✅ User membership activated
```

### 测试 2: 订单查询测试

#### 通过前端查询
1. 进入"个人中心" → "订单历史"
2. 查看刚才创建的订单
3. 订单状态应该显示为"已支付"

#### 通过 API 查询
```bash
# 替换 ORDER_NO 为实际订单号
curl http://localhost:3001/api/payment/query-order?orderNo=XHS1732012345678901234
```

预期响应：
```json
{
  "success": true,
  "order": {
    "order_no": "XHS...",
    "status": "paid",
    "amount": "0.01",
    "plan_type": "monthly"
  }
}
```

### 测试 3: 异步通知测试

支付宝会在支付成功后向后端发送异步通知。

#### 查看通知日志
在后端控制台查找类似日志：
```
📨 Received Alipay notify
✅ Alipay notify signature valid
✅ Payment successful, updating order status
```

#### 手动模拟通知（可选）
```bash
# 注意：这个请求会失败，因为签名无效，但可以测试接口是否正常
curl -X POST http://localhost:3001/api/payment/notify \
  -H "Content-Type: application/x-www-form-urlencoded" \
  -d "out_trade_no=XHS1732012345678901234&trade_status=TRADE_SUCCESS&total_amount=0.01"
```

### 测试 4: 移动端支付测试

#### 使用浏览器开发者工具
1. 打开浏览器开发者工具（F12）
2. 切换到移动设备模拟模式
3. 刷新页面
4. 重复"测试 1"的步骤
5. 系统应该自动使用手机网站支付（WAP）

#### 验证支付方式
查看后端日志，应该看到：
```
✅ Created Alipay WAP payment: XHS...
```

### 测试 5: 错误场景测试

#### 测试取消支付
1. 创建支付订单
2. 在支付宝收银台点击"取消"或关闭页面
3. 返回应用后，订单状态应该仍为"待支付"

#### 测试支付超时
1. 创建支付订单
2. 不进行支付，等待一段时间
3. 查询订单状态，应该仍为"待支付"

#### 测试重复支付
1. 对同一个订单尝试多次支付
2. 系统应该正确处理幂等性

## 📊 验证检查清单

完成以下检查项：

- [ ] ✅ 后端服务正常启动，AlipayService 初始化成功
- [ ] ✅ 前端服务正常启动，可以访问会员购买页面
- [ ] ✅ 创建订单成功，生成唯一订单号
- [ ] ✅ 跳转到支付宝沙箱收银台
- [ ] ✅ 使用沙箱账号完成支付
- [ ] ✅ 支付成功后正确跳转回前端
- [ ] ✅ 订单状态更新为"已支付"
- [ ] ✅ 用户会员权益正确开通
- [ ] ✅ 异步通知签名验证通过
- [ ] ✅ 订单查询接口返回正确数据
- [ ] ✅ 移动端支付流程正常
- [ ] ✅ 错误场景处理正确

## 🔍 常见问题排查

### 问题 1: 支付宝 SDK 初始化失败

**错误信息：** `Missing Alipay configuration`

**解决方案：**
1. 检查 `.env` 文件中的配置是否完整
2. 确认私钥和公钥格式正确（不需要 BEGIN/END 标记）
3. 重启后端服务

### 问题 2: 签名验证失败

**错误信息：** `Alipay notify signature invalid`

**解决方案：**
1. 确认使用的是支付宝公钥，不是应用公钥
2. 检查密钥格式是否正确
3. 确认网关地址是沙箱环境地址

### 问题 3: 支付后没有回调

**可能原因：**
1. 后端服务未启动或无法访问
2. 回调 URL 配置错误
3. 网络问题

**解决方案：**
1. 确认 `BACKEND_URL` 配置正确
2. 检查后端日志是否有收到通知
3. 如果是本地开发，可能需要使用内网穿透工具（如 ngrok）

### 问题 4: 订单状态未更新

**排查步骤：**
1. 检查后端日志，确认收到异步通知
2. 检查签名验证是否通过
3. 检查数据库连接是否正常
4. 查看是否有错误日志

## 🚀 下一步

测试通过后，可以进行以下操作：

1. **切换到生产环境**
   - 更新 `ALIPAY_GATEWAY` 为生产环境地址
   - 使用真实的 APPID 和密钥
   - 配置真实的回调 URL

2. **清理测试数据**
   - 删除测试订单
   - 重置测试用户的会员状态

3. **部署到服务器**
   - 确保服务器可以接收支付宝回调
   - 配置 HTTPS（生产环境必须）
   - 设置正确的域名和回调地址

## 📝 测试记录

记录测试结果：

| 测试项 | 状态 | 备注 |
|--------|------|------|
| 服务启动 | ⏳ 待测试 | |
| 创建订单 | ⏳ 待测试 | |
| 支付流程 | ⏳ 待测试 | |
| 异步通知 | ⏳ 待测试 | |
| 订单查询 | ⏳ 待测试 | |
| 会员开通 | ⏳ 待测试 | |
| 移动端支付 | ⏳ 待测试 | |
| 错误处理 | ⏳ 待测试 | |

---

**测试完成时间：** _____________

**测试人员：** _____________

**测试结果：** ✅ 通过 / ❌ 未通过

**问题记录：** _____________
